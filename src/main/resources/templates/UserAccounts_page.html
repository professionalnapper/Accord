<!DOCTYPE html>
<html lang="en" xmlns:th="http://thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Account Management</title>
    <link rel="icon" href="images/logoHead.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <img class="logo" style="width: 262px; height: 56px;" src="images/logo.png" alt="Logo" />
            
            <div class="nav-items">
                <a href="/dash_admin" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="17.33" height="17.70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <div>Dashboard</div>
                </a>
                
                <a href="/areas-admin" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    <div>Areas Management</div>
                </a>
                
                <a href="/mb-admin" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <div>Manage Bookings</div>
                </a>
                
                <a href="#" class="nav-item active">
                    <svg xmlns="http://www.w3.org/2000/svg" width="17.44" height="17.04" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <div>User Accounts</div>
                </a>

                <a href="/analytics" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    <div>Analytics</div>
                </a>

                <a href="/ratings" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <div>Ratings</div>
                </a>
                
                <div class="nav-divider"></div>
                
                <a href="/" class="logout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <div>Log out</div>
                </a> 
            </div>
            
            <div class="profile">
                <div class="profile-pic">JD</div>
                <div class="profile-info">
                    <div class="profile-name">John Doe</div>
                    <div class="profile-role">Super Admin</div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <h1>Hello, Super admin!</h1>
            <p class="subtitle">Manage and configure the subdivision's recreational areas.</p>

            <div class="table-container">
                <h2>Pending Applications</h2>

                <div class="controls">
                    <input type="text" id="searchInputPending" placeholder="Search applications...">
                    <select id="filterSelectPending">
                        <option value="">All</option>
                        <option value="Renter">Renter</option>
                        <option value="Homeowner">Homeowner</option>
                        <option value="Homeowner - Assumed">Homeowner - Assumed</option>
                    </select>
                </div>

                <table id="pendingTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Property Status</th>
                            <th>Block No.</th>
                            <th>Lot No.</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Pending applications data will be populated here by JavaScript -->
                        <tr th:each="user :${pendingUsers}">
                            <td>
                                [[${user.name}]]
                            </td>
                            <td>
                                <div class="avatar-container">
                                    [[${user.property_status}]]
                                </div>
                            </td>
                            <td>[[${user.block_num}]]</td>
                            <td>[[${user.lot_num}]]</td>
                            <td>
                                <a class="edit-btn">View</a>
                                <a th:href="@{/confirm-account/{id}(id=${user.id})}" class="view-button">Confirm Account</a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="table-container">
                <h2>Users List</h2>

                <div class="controls">
                    <input type="text" id="searchInputUsers" placeholder="Search users...">
                    <select id="filterSelectUsers">
                        <option value="">All</option>
                        <option value="Renter">Renter</option>
                        <option value="Homeowner">Homeowner</option>
                        <option value="Homeowner - Assumed">Homeowner - Assumed</option>
                    </select>
                </div>

                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Property Status</th>
                            <th>Block No.</th>
                            <th>Lot No.</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="user : ${users}">
                            <td th:text="${user.name}">John Doe</td>
                            <td th:text="${user.property_status}">Central Park</td>
                            <td th:text="${user.block_num}">Central Park</td>
                            <td th:text="${user.lot_num}">Central Park</td>
                            <td>
                                <a th:href="@{/details/{id}(id=${user.id})}" class="view-button">View</a>
                            </td>
                   
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Fetch and display users once the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
    // Status mappings
    const statusMappings = {
        'owner': 'Homeowner',
        'owner-assumed': 'Homeowner - Assumed',
        'rental': 'Renter'
    };

    // Table configurations
    const tables = {
        users: {
            searchInput: document.getElementById('searchInputUsers'),
            filterSelect: document.getElementById('filterSelectUsers'),
            tableId: 'usersTable',
        },
        pending: {
            searchInput: document.getElementById('searchInputPending'),
            filterSelect: document.getElementById('filterSelectPending'),
            tableId: 'pendingTable',
        }
    };

    Object.values(tables).forEach(config => {
        const table = document.getElementById(config.tableId);
        if (table) {
            initializeTable(table, config.searchInput, config.filterSelect);
        }
    });

    function initializeTable(table, searchInput, filterSelect) {
        const tableBody = table.querySelector('tbody');
        const originalRows = Array.from(tableBody.rows);

        // Convert initial status values
        originalRows.forEach(row => {
            let status = row.cells[1].textContent.trim().toLowerCase();
            Object.entries(statusMappings).forEach(([dbStatus, displayStatus]) => {
                if (status === dbStatus) {
                    row.cells[1].textContent = displayStatus;
                }
            });
        });

        // Add event listeners for filtering
        searchInput.addEventListener('input', () => filterTable(table, searchInput, filterSelect, originalRows));
        filterSelect.addEventListener('change', () => filterTable(table, searchInput, filterSelect, originalRows));
    }

    function filterTable(table, searchInput, filterSelect, originalRows) {
        const tableBody = table.querySelector('tbody');
        const searchTerm = searchInput.value.toLowerCase();
        const filterValue = filterSelect.value;

        // Clear the current table
        tableBody.innerHTML = '';

        // Filter and add matching rows
        originalRows.forEach(row => {
            const name = row.cells[0].textContent.toLowerCase();
            const status = row.cells[1].textContent.trim();

            const matchesSearch = name.includes(searchTerm);
            const matchesFilter = filterValue === '' || status === filterValue;

            if (matchesSearch && matchesFilter) {
                const newRow = row.cloneNode(true);
                tableBody.appendChild(newRow);
            }
        });

        // Show "No results" message if no matches
        if (tableBody.rows.length === 0) {
            const noResultsRow = document.createElement('tr');
            noResultsRow.innerHTML = `<td colspan="5" style="text-align: center;">No matching results found</td>`;
            tableBody.appendChild(noResultsRow);
        }
    }

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('view-button')) {
            const userId = e.target.getAttribute('href')?.split('/').pop();
            if (userId) {
                e.preventDefault();
                window.location.href = `/details/${userId}`;
            }
        }
        
        if (e.target.classList.contains('edit-btn')) {
            const row = e.target.closest('tr');
            const userId = row.querySelector('.view-button').getAttribute('href')?.split('/').pop();
            if (userId) {
                e.preventDefault();
                window.location.href = `/details/${userId}`;
            }
        }
    });
});

        // Fetch users from the back-end and render them in the table
        function fetchUsers() {
            fetch('/users/list')  // Make sure this endpoint returns users in JSON format
                .then(response => response.json())
                .then(users => {
                    renderUsers(users);
                })
                .catch(error => console.error('Error fetching users:', error));
        }

        // Render the users in the HTML table
        function renderUsers(users) {
            const tableBody = document.querySelector('#usersTable tbody');
            tableBody.innerHTML = '';  // Clear existing table rows

            users.forEach(user => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.property_status}</td>
                    <td>${user.block_num}</td>
                    <td>${user.lot_num}</td>
                    <td>
                        <a href="/users/view/${user.id}" class="view-button">View</a>
                        <button onclick="deleteUser(${user.id})" class="delete-btn3">Delete</button>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Filter users based on search input and property status filter
        function filterUsers() {
            const searchValue = document.getElementById('searchInputUsers').value.toLowerCase();
            const filterValue = document.getElementById('filterSelectUsers').value;

            fetch('/users/list')  // Fetch the full user list again
                .then(response => response.json())
                .then(users => {
                    const filteredUsers = users.filter(user => {
                        const matchesSearch = user.name.toLowerCase().includes(searchValue);
                        const matchesFilter = filterValue === '' || user.property_status === filterValue;
                        return matchesSearch && matchesFilter;
                    });

                    renderUsers(filteredUsers);  // Re-render the filtered users
                })
                .catch(error => console.error('Error filtering users:', error));
        }

        // Redirect to edit user page
        function editUser(userId) {
            window.location.href = `/users/edit/${userId}`;
        }
        function viewUser(userId) {
        window.location.href = `/details/${userId}`;
        }

        // Redirect to delete user confirmation
        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                window.location.href = `/users/delete/${userId}`;
            }
        }

        function filterUsers() {
        const searchValue = document.getElementById('searchInputUsers').value.toLowerCase();
        const filterValue = document.getElementById('filterSelectUsers').value;

        fetch('/users/list')  // Fetch the full user list again
            .then(response => response.json())
            .then(users => {
                const filteredUsers = users.filter(user => {
                    const matchesSearch = user.name.toLowerCase().includes(searchValue);
                    const matchesFilter = filterValue === '' || user.property_status === filterValue;
                    return matchesSearch && matchesFilter;
                });

                renderUsers(filteredUsers);  // Re-render the filtered users
            })
            .catch(error => console.error('Error filtering users:', error));
    }

    function fetchPendingApplications() {
    fetch('/applications/pending') // Ensure this endpoint returns pending applications in JSON format
        .then(response => response.json())
        .then(applications => {
            renderPendingApplications(applications);
        })
        .catch(error => console.error('Error fetching pending applications:', error));
}

function renderPendingApplications(applications) {
    const tableBody = document.querySelector('#pendingTable tbody');
    tableBody.innerHTML = ''; // Clear existing rows

    applications.forEach(application => {
        const row = document.createElement('tr');

        row.innerHTML = `
            <td>${application.name}</td>
            <td>${application.property_status}</td>
            <td>${application.block_num}</td>
            <td>${application.lot_num}</td>
            <td>
                <a href="/confirm-account/${application.id}" class="view-button">Confirm Account</a>
            </td>
        `;

        tableBody.appendChild(row);
    });
}

function filterPendingApplications() {
    const searchValue = document.getElementById('searchInputPending').value.toLowerCase();
    const filterValue = document.getElementById('filterSelectPending').value;

    fetch('/applications/pending') // Fetch the full pending applications list again
        .then(response => response.json())
        .then(applications => {
            const filteredApplications = applications.filter(application => {
                const matchesSearch = application.name.toLowerCase().includes(searchValue);
                const matchesFilter = filterValue === '' || application.property_status === filterValue;
                return matchesSearch && matchesFilter;
            });

            renderPendingApplications(filteredApplications); // Re-render the filtered applications
        })
        .catch(error => console.error('Error filtering pending applications:', error));
        document.addEventListener('DOMContentLoaded', function () {
    // Fetch data on page load
    fetchPendingApplications();
    fetchUsers();

    // Event listeners for Pending Applications filtering
    const searchInputPending = document.getElementById('searchInputPending');
    const filterSelectPending = document.getElementById('filterSelectPending');

    searchInputPending.addEventListener('input', filterPendingApplications);
    filterSelectPending.addEventListener('change', filterPendingApplications);

    // Event listeners for Users List filtering
    const searchInput = document.getElementById('searchInputUsers');
    const filterSelect = document.getElementById('filterSelectUsers');

    searchInput.addEventListener('input', filterUsers);
    filterSelect.addEventListener('change', filterUsers);
});
}
    </script>
</body>
</html>